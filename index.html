<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Robot Irrigation Control</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f7fa;
    }
    #map {
      height: 70vh;
      width: 100%;
    }
    .controls {
      padding: 15px;
      background: #fff;
      border-bottom: 1px solid #ccc;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: center;
    }
    .controls label {
      font-size: 14px;
      margin-right: 5px;
    }
    .controls input, .controls select, .controls button {
      padding: 5px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .area-display {
      margin-top: 10px;
      font-size: 16px;
      font-weight: bold;
      text-align: center;
    }
    .search-container {
      margin-top: 10px;
      text-align: center;
    }
    .search-container input {
      width: 200px;
      padding: 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>
 
  <div class="controls">
    <label for="plantType">Plant Type:</label>
    <select id="plantType">
      <option value="grass">Grass</option>
      <option value="trees">Trees</option>
      <option value="shrubs">Shrubs</option>
    </select>

    <label for="sprinklerRadius">Sprinkler Radius (m):</label>
    <input type="number" id="sprinklerRadius" placeholder="e.g., 5" min="1" />

    <label for="waterFlowRate">Water Flow Rate (L/min):</label>
    <input type="number" id="waterFlowRate" placeholder="e.g., 10" min="1" />

    <button onclick="calculateIrrigation()">Calculate</button>
  </div>

  <div class="search-container">
    <input type="text" id="searchLocation" placeholder="Search for a location..." />
    <button onclick="searchLocation()">Search</button>
  </div>

  <div class="area-display" id="areaDisplay">
    المساحة المحددة: <span id="areaValue">0</span> م²
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script>
    // Initialize map
    const map = L.map('map').setView([30.0444, 31.2357], 16); // Default coordinates (Cairo)
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // Add Leaflet.draw controls
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      edit: {
        featureGroup: drawnItems,
        remove: true
      },
      draw: {
        polygon: true,
        marker: false,
        polyline: false,
        rectangle: true,
        circle: false,
        circlemarker: false
      }
    });
    map.addControl(drawControl);

    // Handle draw created event
    let selectedArea = null;
    map.on(L.Draw.Event.CREATED, function (event) {
      const layer = event.layer;
      drawnItems.addLayer(layer);
      selectedArea = layer;

      // Calculate area
      const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]); // Area in m²
      document.getElementById('areaValue').innerText = (area / 1).toFixed(2); // Display area in m²
      layer.bindPopup(`Area: ${(area / 1).toFixed(2)} m²`).openPopup();
    });

    // Function to calculate irrigation data
    function calculateIrrigation() {
      const plantType = document.getElementById('plantType').value;
      const sprinklerRadius = parseFloat(document.getElementById('sprinklerRadius').value);
      const waterFlowRate = parseFloat(document.getElementById('waterFlowRate').value);

      if (!sprinklerRadius || !waterFlowRate || !selectedArea) {
        alert('Please fill in all inputs and select an area on the map.');
        return;
      }

      // consumption values (L/day) per m² for different plants
      const waterConsumption = {
        grass: 5,   // Grass consumes 5 L/day/m²
        trees: 10,  // Trees consume 10 L/day/m²
        shrubs: 7   // Shrubs consume 7 L/day/m²
      };

      // Calculate irrigation points
      const bounds = selectedArea.getBounds();
      const latlngs = [];
      const latStep = (sprinklerRadius * 1.2) / 111320; // Convert meters to degrees (latitude) with slight overlap
      const lngStep = (sprinklerRadius * 1.2) / (111320 * Math.cos(bounds.getCenter().lat * (Math.PI / 180))); // Convert meters to degrees (longitude) with slight overlap

 // الدالة للتحقق من وجود نقطة داخل مضلع
function isPointInPolygon(point, polygon) {
    const x = point.lat, y = point.lng;
    let inside = false;
    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
      const xi = polygon[i].lat, yi = polygon[i].lng;
      const xj = polygon[j].lat, yj = polygon[j].lng;
      const intersect = ((yi > y) !== (yj > y)) &&
        (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
      if (intersect) inside = !inside;
    }
    return inside;
  }
  
  const polygonLatLngs = selectedArea.getLatLngs()[0]; // إحداثيات المضلع

// توسيع الحدود بشكل أكبر
for (let lat = bounds.getSouthWest().lat - 0.5 * latStep; lat < bounds.getNorthEast().lat + 0.5* latStep; lat += latStep) {
  for (let lng = bounds.getSouthWest().lng - 0.5 * lngStep; lng < bounds.getNorthEast().lng + 0.5 * lngStep; lng += lngStep) {
    const point = L.latLng(lat, lng);
    console.log("Generated Point:", point); // فحص النقاط المولدة
    if (isPointInPolygon(point, polygonLatLngs)) {
      latlngs.push(point);
    }
  }
}

      // Clear previous markers and circles
      drawnItems.clearLayers();

      // Add new markers and circles
      let firstPoint = null;
      let lastPoint = null;
      latlngs.forEach((latlng, index) => {
        const marker = L.marker(latlng).addTo(drawnItems);
        const circle = L.circle(latlng, { radius: sprinklerRadius }).addTo(drawnItems);
        marker.bindPopup(`Robot Point: ${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}`).openPopup();

        if (index === 0) firstPoint = latlng;
        if (index === latlngs.length - 1) lastPoint = latlng;
      });

      // Calculate irrigation time
      const area = L.GeometryUtil.geodesicArea(selectedArea.getLatLngs()[0]); // Area in m²
      const dailyWaterNeed = area * waterConsumption[plantType]; // Total water need per day
      const irrigationTime = (dailyWaterNeed / waterFlowRate).toFixed(2); // Irrigation time in minutes

      // Display all data in alert
      const alertMessage = `
        Plant Type: ${plantType}
        Area Covered: ${(area / 1).toFixed(2)} m²
        Daily Water Need: ${dailyWaterNeed.toFixed(2)} L
        Water Flow Rate: ${waterFlowRate} L/min
        Estimated Irrigation Time: ${irrigationTime} minutes
        First Robot Point: ${firstPoint.lat.toFixed(5)}, ${firstPoint.lng.toFixed(5)}
        Last Robot Point: ${lastPoint.lat.toFixed(5)}, ${lastPoint.lng.toFixed(5)}
      `;
      alert(alertMessage);

      // Send data to Raspberry Pi (example using fetch API)
      const robotPoints = latlngs.map(point => ({
        lat: point.lat.toFixed(5),
        lng: point.lng.toFixed(5)
      }));

      const dataToSend = {
        plantType,
        sprinklerRadius,
        waterFlowRate,
        area: (area / 1).toFixed(2),
        dailyWaterNeed: dailyWaterNeed.toFixed(2),
        irrigationTime,
        robotPoints
      };

      //Send data to Raspberry Pi
      fetch('http://your-raspberry-pi-ip/endpoint', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(dataToSend)
      })
        .then(response => response.json())
        .then(data => {
          console.log('Data sent to Raspberry Pi:', data);
        })
        .catch(error => {
          console.error('Error sending data to Raspberry Pi:', error);
        });
    }

    // Function to search for a location
    function searchLocation() {
      const query = document.getElementById('searchLocation').value;
      if (!query) return;

      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`)
        .then(response => response.json())
        .then(data => {
          if (data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            map.setView([lat, lon], 16);
          } else {
            alert('Location not found!');
          }
        })
        .catch(error => {
          console.error('Error searching location:', error);
        });
    }
  </script>
</body>
</html>